name: SomafractalMemoryStandAlone

services:
  somafractalmemory_standalone_postgres:
    image: postgres:15
    container_name: somafractalmemory_standalone_postgres
    environment:
      POSTGRES_USER: soma
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-soma}
      POSTGRES_DB: somamemory
      POSTGRES_HOST_AUTH_METHOD: md5
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=C"
    ports:
      - "${POSTGRES_HOST_PORT:-10432}:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
    command: >
      postgres -c max_connections=100 -c shared_buffers=384MB -c effective_cache_size=1024MB -c maintenance_work_mem=64MB -c work_mem=4MB -c wal_buffers=8MB -c checkpoint_completion_target=0.9 -c random_page_cost=1.1 -c effective_io_concurrency=200 -c min_wal_size=512MB -c max_wal_size=2GB -c max_worker_processes=2 -c max_parallel_workers_per_gather=1 -c max_parallel_workers=2 -c max_parallel_maintenance_workers=1 -c log_min_duration_statement=1000 -c log_checkpoints=on -c log_connections=on -c log_disconnections=on -c log_lock_waits=on -c idle_in_transaction_session_timeout=60000 -c statement_timeout=300000
    restart: always
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -h localhost -p 5432 -U soma" ]
      interval: 10s
      timeout: 5s
      retries: 5
    profiles:
      - core
    networks:
      somafractalmemory_standalone_net:
        aliases:
          - standalone-postgres

  somafractalmemory_standalone_redis:
    image: redis:7
    container_name: somafractalmemory_standalone_redis
    ports:
      - "${REDIS_HOST_PORT:-10379}:6379"
    volumes:
      - redisdata:/data
    command: >
      redis-server --maxmemory 400mb --maxmemory-policy allkeys-lru --maxclients 5000 --tcp-backlog 511 --timeout 0 --tcp-keepalive 300 --save 900 1 --save 300 10 --save 60 10000 --appendonly yes --appendfsync everysec --no-appendfsync-on-rewrite no --auto-aof-rewrite-percentage 100 --auto-aof-rewrite-min-size 64mb --activerehashing yes --hz 10 --dynamic-hz yes --lazyfree-lazy-eviction yes --lazyfree-lazy-expire yes --lazyfree-lazy-server-del yes --replica-lazy-flush yes
    restart: always
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M
    healthcheck:
      test: [ "CMD", "redis-cli", "-p", "6379", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5
    profiles:
      - core
    networks:
      somafractalmemory_standalone_net:
        aliases:
          - standalone-redis

  somafractalmemory_standalone_etcd:
    image: quay.io/coreos/etcd:v3.5.5
    container_name: somafractalmemory_standalone_etcd
    volumes:
      - etcddata:/etcd
    command: >
      etcd --advertise-client-urls=http://standalone-etcd:2379 --listen-client-urls=http://0.0.0.0:2379 --data-dir=/etcd --auto-compaction-mode=periodic --auto-compaction-retention=1h --quota-backend-bytes=8589934592 --snapshot-count=10000 --max-txn-ops=10000 --max-request-bytes=10485760
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M
    healthcheck:
      test: [ "CMD", "etcdctl", "endpoint", "health" ]
      interval: 30s
      timeout: 20s
      retries: 3
    profiles:
      - core
    networks:
      somafractalmemory_standalone_net:
        aliases:
          - standalone-etcd

  somafractalmemory_standalone_minio:
    image: minio/minio:RELEASE.2023-03-20T20-16-18Z
    container_name: somafractalmemory_standalone_minio
    environment:
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin
    volumes:
      - miniodata:/minio_data
    command: minio server /minio_data --console-address ":9001"
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:9000/minio/health/live" ]
      interval: 30s
      timeout: 20s
      retries: 3
    profiles:
      - core
    networks:
      somafractalmemory_standalone_net:
        aliases:
          - standalone-minio

  somafractalmemory_standalone_milvus:
    image: milvusdb/milvus:v2.3.3
    container_name: somafractalmemory_standalone_milvus
    command: [ "milvus", "run", "standalone" ]
    ports:
      - "${MILVUS_HOST_PORT:-10530}:19530"
      - "${MILVUS_GRPC_PORT:-10531}:9091"
    environment:
      ETCD_ENDPOINTS: standalone-etcd:2379
      MINIO_ADDRESS: standalone-minio:9000
      MINIO_ACCESS_KEY_ID: minioadmin
      MINIO_SECRET_ACCESS_KEY: minioadmin
      MINIO_USE_SSL: "false"
      MINIO_BUCKET_NAME: "milvus-bucket"
      MINIO_ROOT_PATH: "milvus"
    volumes:
      - milvusdata:/var/lib/milvus
    restart: on-failure
    depends_on:
      somafractalmemory_standalone_etcd:
        condition: service_healthy
      somafractalmemory_standalone_minio:
        condition: service_healthy
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://localhost:9091/healthz || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s
    profiles:
      - core
    networks:
      somafractalmemory_standalone_net:
        aliases:
          - standalone-milvus

  somafractalmemory_standalone_opa:
    image: openpolicyagent/opa:latest-debug
    container_name: somafractalmemory_standalone_opa
    command:
      - "run"
      - "--server"
      - "--addr=0.0.0.0:8181"
      - "--log-level=info"
    ports:
      - "${OPA_PORT:-10818}:8181"
    deploy:
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 64M
    healthcheck:
      test: [ "CMD-SHELL", "wget -q --tries=1 -O - http://127.0.0.1:8181/health || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 3
    profiles:
      - core
    networks:
      somafractalmemory_standalone_net:
        aliases:
          - opa

  somafractalmemory_standalone_api:
    build:
      context: ../..
      dockerfile: infra/standalone/Dockerfile
    container_name: somafractalmemory_standalone_api
    ports:
      - "10101:10101"
    environment:
      # Security
      SOMA_API_TOKEN: "dev-token-somastack2024"
      SOMA_SECRET_KEY: "dev-secret-key-CHANGE-IN-PROD"
      SOMA_ALLOWED_HOSTS: "*"
      # Rate limiting (disabled for dev)
      SOMA_RATE_LIMIT_MAX: "0"
      SOMA_RATE_LIMIT_WINDOW_SECONDS: "0"
      # Configuration
      CONFIG_FILE: /app/config.yaml
      SOMA_FORCE_HASH_EMBEDDINGS: "0"
      PYTHONUNBUFFERED: "1"
      PYTHONDONTWRITEBYTECODE: "1"
      # Database (individual settings required by Django DATABASES)
      SOMA_DB_NAME: somamemory
      SOMA_DB_USER: soma
      SOMA_DB_PASSWORD: soma
      SOMA_DB_HOST: standalone-postgres
      SOMA_DB_PORT: "5432"
      SOMA_POSTGRES_URL: postgresql://soma:soma@standalone-postgres:5432/somamemory
      # Redis
      SOMA_REDIS_HOST: standalone-redis
      SOMA_REDIS_PORT: "6379"
      # Milvus
      SOMA_MILVUS_HOST: standalone-milvus
      SOMA_MILVUS_PORT: "19530"
      # Django
      DJANGO_SETTINGS_MODULE: somafractalmemory.settings
    depends_on:
      somafractalmemory_standalone_postgres:
        condition: service_healthy
      somafractalmemory_standalone_redis:
        condition: service_healthy
      somafractalmemory_standalone_milvus:
        condition: service_started
    volumes:
      - ../..:/app:delegated
      - hf_cache:/root/.cache/huggingface
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:${SOMA_API_PORT:-10101}/healthz" ]
      interval: 30s
      timeout: 5s
      retries: 5
    restart: always
    profiles:
      - core
    networks:
      somafractalmemory_standalone_net:
        aliases:
          - standalone-api

volumes:
  pgdata:
    driver: local
  redisdata:
    driver: local
  milvusdata:
    driver: local
  etcddata:
    driver: local
  miniodata:
    driver: local
  hf_cache:
    driver: local

networks:
  somafractalmemory_standalone_net:
    name: soma_shared_net
    external: true
