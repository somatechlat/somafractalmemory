# SFM Standalone Stack
services:
  # --- Redis cache -------------------------------------------
  somafractalmemory-standalone-redis:
    image: redis:7.2-alpine
    container_name: somafractalmemory-standalone-redis
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - somafractalmemory-standalone-net
    ports:
      - "10379:6379"

  # --- Vault secrets -----------------------------------------
  somafractalmemory-standalone-vault:
    image: hashicorp/vault:1.13.3
    container_name: somafractalmemory-standalone-vault
    restart: unless-stopped
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: "${SFM_VAULT_TOKEN:?set SFM_VAULT_TOKEN}"
      VAULT_ADDR: "http://0.0.0.0:8200"
    ports:
      - "18200:8200"
    cap_add:
      - IPC_LOCK
    healthcheck:
      test: [ "CMD", "vault", "status" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - somafractalmemory-standalone-net

  # --- Vault init helper -------------------------------------
  somafractalmemory-standalone-vault-init:
    image: alpine:latest
    container_name: somafractalmemory-standalone-vault-init
    depends_on:
      somafractalmemory-standalone-vault:
        condition: service_healthy
    environment:
      SFM_VAULT_TOKEN: "${SFM_VAULT_TOKEN:?set SFM_VAULT_TOKEN}"
      SFM_DB_USER: "${SFM_DB_USER:-somafractalmemory}"
      SFM_DB_PASSWORD: "${SFM_DB_PASSWORD:?set SFM_DB_PASSWORD}"
      SFM_DB_NAME: "${SFM_DB_NAME:-somafractalmemory}"
      SFM_REDIS_PASSWORD: "${SFM_REDIS_PASSWORD:-}"
    networks:
      - somafractalmemory-standalone-net
    entrypoint: [ "sh", "-c" ]
    command:
      - |
        apk add --no-cache curl jq
        # Wait for vault to be ready
        until curl -s http://somafractalmemory-standalone-vault:8200/v1/sys/health; do sleep 1; done
        # Mount KV v2
        curl -H "X-Vault-Token: $${SFM_VAULT_TOKEN}" -X POST -d '{"type":"kv-v2"}' http://somafractalmemory-standalone-vault:8200/v1/sys/mounts/somafractalmemory

        # Write Database Credentials
        curl -H "X-Vault-Token: $${SFM_VAULT_TOKEN}" -X POST \
          -d "{\"data\": {\"username\": \"$${SFM_DB_USER}\", \"password\": \"$${SFM_DB_PASSWORD}\", \"host\": \"somafractalmemory-standalone-postgres\", \"port\": 5432, \"dbname\": \"$${SFM_DB_NAME}\"}}" \
          http://somafractalmemory-standalone-vault:8200/v1/somafractalmemory/data/database

        # Write Redis Credentials
        curl -H "X-Vault-Token: $${SFM_VAULT_TOKEN}" -X POST \
          -d "{\"data\": {\"host\": \"somafractalmemory-standalone-redis\", \"port\": 6379, \"password\": \"$${SFM_REDIS_PASSWORD}\"}}" \
          http://somafractalmemory-standalone-vault:8200/v1/somafractalmemory/data/redis

        echo "Vault initialized and secrets populated."

  # --- Database ----------------------------------------------
  somafractalmemory-standalone-postgres:
    image: postgres:15-alpine
    container_name: somafractalmemory-standalone-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: "${SFM_DB_NAME:-somafractalmemory}"
      POSTGRES_USER: "${SFM_DB_USER:-somafractalmemory}"
      POSTGRES_PASSWORD: "${SFM_DB_PASSWORD:?set SFM_DB_PASSWORD}"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "10432:5432"
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U somafractalmemory" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - somafractalmemory-standalone-net

  # --- OPA ---------------------------------------------------
  somafractalmemory-standalone-opa:
    image: openpolicyagent/opa:0.54.0
    container_name: somafractalmemory-standalone-opa
    restart: unless-stopped
    ports:
      - "10818:8181"
    command:
      - "run"
      - "--server"
      - "--log-level=info"
    healthcheck:
      test: [ "CMD", "/opa", "eval", "time.now_ns()" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - somafractalmemory-standalone-net

  # --- Etcd --------------------------------------------------
  somafractalmemory-standalone-etcd:
    image: quay.io/coreos/etcd:v3.5.5
    container_name: somafractalmemory-standalone-etcd
    restart: unless-stopped
    environment:
      ETCD_AUTO_COMPACTION_RETENTION: "1"
      ETCD_LISTEN_CLIENT_URLS: "http://0.0.0.0:2379"
      ETCD_ADVERTISE_CLIENT_URLS: "http://somafractalmemory-standalone-etcd:2379"
    healthcheck:
      test: [ "CMD", "etcdctl", "endpoint", "health" ]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - somafractalmemory-standalone-net

  # --- MinIO -------------------------------------------------
  somafractalmemory-standalone-minio:
    image: minio/minio:RELEASE.2023-03-20T20-16-18Z
    container_name: somafractalmemory-standalone-minio
    restart: unless-stopped
    environment:
      MINIO_ROOT_USER: "${SFM_MINIO_ROOT_USER:?set SFM_MINIO_ROOT_USER}"
      MINIO_ROOT_PASSWORD: "${SFM_MINIO_ROOT_PASSWORD:?set SFM_MINIO_ROOT_PASSWORD}"
    command: server /data
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:9000/minio/health/live" ]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      somafractalmemory-standalone-net:
        aliases:
          - minio

  # --- Milvus vector store -----------------------------------
  somafractalmemory-standalone-milvus:
    image: milvusdb/milvus:v2.3.3
    container_name: somafractalmemory-standalone-milvus
    restart: unless-stopped
    depends_on:
      somafractalmemory-standalone-etcd:
        condition: service_healthy
      somafractalmemory-standalone-minio:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 4G
    environment:
      ETCD_ENDPOINTS: "somafractalmemory-standalone-etcd:2379"
      MINIO_ADDRESS: "minio:9000"
      MINIO_ACCESS_KEY: "${SFM_MINIO_ROOT_USER:?set SFM_MINIO_ROOT_USER}"
      MINIO_SECRET_KEY: "${SFM_MINIO_ROOT_PASSWORD:?set SFM_MINIO_ROOT_PASSWORD}"
    volumes:
      - milvus_data:/var/lib/milvus
    ports:
      - "10530:19530"
      - "10531:9091"
    command: [ "milvus", "run", "standalone" ]
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:9091/healthz" ]
      interval: 30s
      timeout: 20s
      retries: 10
      start_period: 180s
    networks:
      - somafractalmemory-standalone-net

  somafractalmemory-standalone-api:
    build:
      context: ../..
      dockerfile: infra/standalone/Dockerfile
    image: somafractalmemory:latest
    container_name: somafractalmemory-standalone-api
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 2G
    depends_on:
      somafractalmemory-standalone-vault-init:
        condition: service_completed_successfully
      somafractalmemory-standalone-redis:
        condition: service_healthy
      somafractalmemory-standalone-postgres:
        condition: service_healthy
      somafractalmemory-standalone-opa:
        condition: service_healthy
      somafractalmemory-standalone-milvus:
        condition: service_healthy
    networks:
      - somafractalmemory-standalone-net
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      DJANGO_SETTINGS_MODULE: "somafractalmemory.settings.standalone"
      # VAULT BOOTSTRAP ONLY
      VAULT_ADDR: "http://somafractalmemory-standalone-vault:8200"
      VAULT_TOKEN: "${SFM_VAULT_TOKEN:?set SFM_VAULT_TOKEN}"
      SOMA_LOG_LEVEL: "INFO"
      SOMA_ALLOWED_HOSTS: "${SOMA_ALLOWED_HOSTS:-localhost,127.0.0.1}"
      SOMA_API_TOKEN: "${SOMA_API_TOKEN:?set SOMA_API_TOKEN}"
      SOMA_API_PORT: "10101"
      # INFRA HOST NAMES ONLY (Credentials via Vault)
      SOMA_DB_HOST: "somafractalmemory-standalone-postgres"
      SOMA_REDIS_HOST: "somafractalmemory-standalone-redis"
      SOMA_MILVUS_HOST: "somafractalmemory-standalone-milvus"
      SOMA_OPA_URL: "http://somafractalmemory-standalone-opa:8181"
    ports:
      - "10101:10101"
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://localhost:10101/health || exit 1" ]
      interval: 30s
      timeout: 10s
      start_period: 30s
      retries: 5
    cap_drop: [ "ALL" ]
    read_only: false
    security_opt:
      - no-new-privileges:true

networks:
  somafractalmemory-standalone-net:
    driver: bridge

volumes:
  postgres_data:
  milvus_data:
  etcd_data:
  redis_data:
  opa_data:
