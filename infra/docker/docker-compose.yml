# SomaFractalMemory Docker Compose (Mirrors K8s sfm-resilient.yaml)
# VIBE Rule 107: Legacy Parity Mandate
# VIBE Rule 113: Port Sovereignty - SFM uses 10xxx range

services:
  sfm-api:
    build:
      context: ../..
      dockerfile: infra/docker/Dockerfile
    ports:
      - "10101:10101"
    environment:
      # From ConfigMap sfm-config
      - DJANGO_ENV=production
      - DJANGO_SETTINGS_MODULE=somafractalmemory.settings
      - SOMA_API_PORT=10101
      - SOMA_DB_NAME=somamemory
      - SOMA_POSTGRES_URL=postgresql://soma:soma@postgres:5432/somamemory
      - SOMA_REDIS_HOST=redis
      - SOMA_REDIS_PORT=6379
      - SOMA_MILVUS_HOST=milvus
      - SOMA_MILVUS_PORT=19530
      - SOMA_API_TOKEN=dev-token-somastack2024
      - PYTHONUNBUFFERED=1
      - ALLOWED_HOSTS=*
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
      milvus:
        condition: service_started
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:10101/healthz" ]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 384M
          cpus: '1'

  postgres:
    image: postgres:15-alpine
    ports:
      - "30201:5432"
    environment:
      - POSTGRES_USER=soma
      - POSTGRES_PASSWORD=soma
      - POSTGRES_DB=somamemory
      - POSTGRES_HOST_AUTH_METHOD=trust
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U soma -d somamemory" ]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1'

  redis:
    image: redis:7-alpine
    ports:
      - "30202:6379"
    volumes:
      - redis-data:/data
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'

  milvus:
    image: milvusdb/milvus:v2.3.4
    command: [ "milvus", "run", "standalone" ]
    ports:
      - "30203:19530"
    environment:
      - ETCD_USE_EMBED=true
      - ETCD_DATA_DIR=/var/lib/milvus/etcd
      - COMMON_STORAGETYPE=local
    volumes:
      - milvus-data:/var/lib/milvus
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '2'

volumes:
  pgdata:
  redis-data:
  milvus-data:
